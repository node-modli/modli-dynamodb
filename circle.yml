machine:
  services:
    - docker
  node:
    version: 4.2.1

dependencies:
  cache_directories:
    - "~/docker"
    - node_modules
  override:
    - chmod 600 ~/.ssh/config
    - npm install -g devlab
    # These next large blocks handle caching of Docker layers for our build box and
    # service dependencies. They'll still be updated to the latest version even with
    # the cache, however build times will improve if we manually clear the cache after
    # there's been an update so we don't have to pull it down each time.
    - |
      if [[ -e ~/docker/ta_node_4.tar ]]; then
        docker load -i ~/docker/ta_node_4.tar
      else
        docker pull technologyadvice/node-build:4 &&
        mkdir -p ~/docker &&
        docker save technologyadvice/node-build:4 > ~/docker/ta_node_4.tar
      fi
    - lab ci-install

test:
  override:
    - lab ci
  post:
    # Switch .ssh out of Docker/root ownership
    - sudo chown -R ubuntu:ubuntu /home/ubuntu/.ssh

general:
  artifacts:
    - coverage
